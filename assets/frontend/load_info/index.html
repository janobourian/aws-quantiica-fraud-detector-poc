<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quantiica | Carga de Datos</title>

  <link rel="icon" type="image/webp" href="./logo.webp" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg: #0E1117;
      --panel: #151A22;
      --card: #1A202B;
      --border: #2B3444;
      --text: #FAFAFA;
      --muted: #AAB3C5;
      --ok: #00CC96;
      --warn: #FFA500;
      --risk: #FF4B4B;
    }

    html, body { height: 100%; }
    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .app-shell{ 
      padding: 22px;
      max-width: 600px;
      margin: 0 auto;
    }

    .topbar{
      background: rgba(21,26,34,0.72);
      border: 1px solid rgba(43,52,68,0.85);
      border-radius: 16px;
      padding: 14px 16px;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .brand img{
      height: 42px;
      width: auto;
    }
    .brand-title{
      font-weight: 700;
      font-size: 16px;
      margin: 0;
    }
    .brand-sub{
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    .panel-card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
    }

    .panel-title{
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(43,52,68,0.65);
    }

    .form-label{
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .form-control, .form-select{
      background: #0F141C;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .form-control:focus, .form-select:focus{
      background: #0F141C;
      border-color: var(--ok);
      color: var(--text);
      box-shadow: 0 0 0 0.2rem rgba(0,204,150,0.25);
    }
    .form-control::placeholder{ color: #7d879d; }

    .btn-primary{
      background: var(--ok);
      border: 1px solid rgba(0,0,0,0.2);
      color: #00120b;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 800;
    }
    .btn-primary:hover{
      background: #00b386;
      border-color: rgba(0,0,0,0.2);
    }

    .btn-secondary{
      background: #0F141C;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 700;
    }
    .btn-secondary:hover{
      border-color: #3b4a63;
      color: var(--text);
    }

    .alert-success{
      background: rgba(0,204,150,0.15);
      border: 1px solid var(--ok);
      border-radius: 14px;
      color: var(--ok);
    }

    .alert-danger{
      background: rgba(255,75,75,0.15);
      border: 1px solid var(--risk);
      border-radius: 14px;
      color: var(--risk);
    }

    .table-darkish{
      --bs-table-bg: #0F141C;
      --bs-table-border-color: rgba(43,52,68,0.85);
      --bs-table-color: var(--text);
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(43,52,68,0.85);
    }

    .accordion-button{
      background: #0F141C;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
    }
    .accordion-button:not(.collapsed){
      background: #0F141C;
      color: var(--ok);
      border-color: var(--ok);
    }
    .accordion-button:focus{
      box-shadow: 0 0 0 0.2rem rgba(0,204,150,0.25);
    }
    .accordion-item{
      background: transparent;
      border: none;
      margin-bottom: 12px;
    }
    .accordion-body{
      padding: 0;
      padding-top: 12px;
    }

    .badge-status{
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 11px;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <div class="topbar">
      <div class="brand">
        <img src="./logo.webp" alt="Logo" />
        <div>
          <p class="brand-title">Quantiica</p>
          <p class="brand-sub">Carga de Datos</p>
        </div>
      </div>
    </div>

    <div class="accordion" id="csvAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCsv">
            üì§ Carga Masiva desde CSV
          </button>
        </h2>
        <div id="collapseCsv" class="accordion-collapse collapse" data-bs-parent="#csvAccordion">
          <div class="accordion-body">
            <div class="panel-card">
                  <div class="mb-3">
                    <label class="form-label">üë§ Clientes CSV</label>
                    <input type="file" class="form-control mb-2" id="clientCsvFile" accept=".csv">
                    <small class="text-muted d-block mb-2">Columnas: client_id, rfc, ocupation, risk_level, person_type, first_name, last_name, city, state, country, account_id</small>
                    <button class="btn btn-primary w-100" id="uploadClientsBtn" disabled>üì§ Cargar Clientes</button>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">üí≥ Transacciones CSV</label>
                    <input type="file" class="form-control mb-2" id="transactionCsvFile" accept=".csv">
                    <small class="text-muted d-block mb-2">Columnas: transaction_id, movement_type, tx_type, client_account_id, counterparty_account_id, amount</small>
                    <button class="btn btn-primary w-100" id="uploadTransactionsBtn" disabled>üì§ Cargar Transacciones</button>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">üè¢ Contrapartes CSV</label>
                    <input type="file" class="form-control mb-2" id="counterpartyCsvFile" accept=".csv">
                    <small class="text-muted d-block mb-2">Columnas: counterparty_id, person_type, account_id, country, state, industry, risk_level, is_client, name</small>
                    <button class="btn btn-primary w-100" id="uploadCounterpartiesBtn" disabled>üì§ Cargar Contrapartes</button>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">üìä Estado Transaccional Clientes CSV</label>
                    <input type="file" class="form-control mb-2" id="clientsTxStateCsvFile" accept=".csv">
                    <small class="text-muted d-block mb-2">Columnas: client_tx_state_id, client_account_id, last_tx_timestamp, tx_count, tx_sum, tx_square_sum, avg_tx_amount, std_tx_amount</small>
                    <button class="btn btn-primary w-100" id="uploadClientsTxStateBtn" disabled>üì§ Cargar Estado Transaccional</button>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">üïí Actividad Reciente Clientes CSV</label>
                    <input type="file" class="form-control mb-2" id="clientRecentActivityCsvFile" accept=".csv">
                    <small class="text-muted d-block mb-2">Columnas: client_recent_activity_id, client_account_id, created_at, updated_at, tx_count, unique_counterparties</small>
                    <button class="btn btn-primary w-100" id="uploadClientRecentActivityBtn" disabled>üì§ Cargar Actividad Reciente</button>
                  </div>
              <div id="uploadAlert" class="mt-3" style="display:none;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-2">
      <div class="accordion" id="clientAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClient">
              üë§ Cargar Cliente
            </button>
          </h2>
          <div id="collapseClient" class="accordion-collapse collapse" data-bs-parent="#clientAccordion">
            <div class="accordion-body">
              <div class="panel-card">
                  <form id="clientForm">
                    <div class="mb-3">
                      <label class="form-label">RFC</label>
                      <input type="text" class="form-control" name="rfc" required placeholder="Ej: PEJU800101XXX">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Ocupaci√≥n</label>
                      <input type="text" class="form-control" name="ocupation" required placeholder="Ej: Empresario">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Nivel de Riesgo</label>
                      <select class="form-select" name="risk_level" required>
                        <option value="">Seleccionar...</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Tipo de Persona</label>
                      <select class="form-select" name="person_type" required>
                        <option value="">Seleccionar...</option>
                        <option value="Fisica">F√≠sica</option>
                        <option value="Moral">Moral</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Nombre</label>
                      <input type="text" class="form-control" name="first_name" required placeholder="Ej: Juan">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Apellido</label>
                      <input type="text" class="form-control" name="last_name" required placeholder="Ej: P√©rez">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Ciudad</label>
                      <input type="text" class="form-control" name="city" required placeholder="Ej: Ciudad de M√©xico">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Estado</label>
                      <input type="text" class="form-control" name="state" required placeholder="Ej: CDMX">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Pa√≠s</label>
                      <input type="text" class="form-control" name="country" required placeholder="Ej: M√©xico">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">ID de Cuenta</label>
                      <input type="text" class="form-control" name="account_id" required placeholder="Ej: ACC-12345">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">üíæ Guardar Cliente</button>
                  </form>
                <div id="clientAlert" class="mt-3" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-2">
      <div class="accordion" id="transactionAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTransaction">
              üí≥ Cargar Transacci√≥n
            </button>
          </h2>
          <div id="collapseTransaction" class="accordion-collapse collapse" data-bs-parent="#transactionAccordion">
            <div class="accordion-body">
              <div class="panel-card">
                  <form id="transactionForm">
                    <div class="mb-3">
                      <label class="form-label">Tipo de Movimiento</label>
                      <select class="form-select" name="movement_type" required>
                        <option value="">Seleccionar...</option>
                        <option value="IN">IN (Entrada)</option>
                        <option value="OUT">OUT (Salida)</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Tipo de Transacci√≥n</label>
                      <select class="form-select" name="tx_type" required>
                        <option value="">Seleccionar...</option>
                        <option value="SPEI">SPEI</option>
                        <option value="SWIFT">SWIFT</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">ID Cuenta Cliente</label>
                      <input type="text" class="form-control" name="client_account_id" required placeholder="Ej: CLI-12345">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">ID Cuenta Contraparte</label>
                      <input type="text" class="form-control" name="counterparty_account_id" required placeholder="Ej: CTR-98765">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Monto (USD)</label>
                      <input type="number" class="form-control" name="amount" required placeholder="Ej: 10000" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">üíæ Guardar Transacci√≥n</button>
                  </form>
                <div id="transactionAlert" class="mt-3" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-2">
      <div class="accordion" id="counterpartyAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCounterparty">
              üè¢ Cargar Contraparte
            </button>
          </h2>
          <div id="collapseCounterparty" class="accordion-collapse collapse" data-bs-parent="#counterpartyAccordion">
            <div class="accordion-body">
              <div class="panel-card">
                  <form id="counterpartyForm">
                    <div class="mb-3">
                      <label class="form-label">Nombre</label>
                      <input type="text" class="form-control" name="name" required placeholder="Ej: Empresa ABC">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Tipo de Persona</label>
                      <select class="form-select" name="person_type" required>
                        <option value="">Seleccionar...</option>
                        <option value="Fisica">F√≠sica</option>
                        <option value="Moral">Moral</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">ID de Cuenta</label>
                      <input type="text" class="form-control" name="account_id" required placeholder="Ej: CTR-12345">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Pa√≠s</label>
                      <input type="text" class="form-control" name="country" required placeholder="Ej: M√©xico">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Estado</label>
                      <input type="text" class="form-control" name="state" required placeholder="Ej: CDMX">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Industria</label>
                      <input type="text" class="form-control" name="industry" required placeholder="Ej: Tecnolog√≠a">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Nivel de Riesgo</label>
                      <select class="form-select" name="risk_level" required>
                        <option value="">Seleccionar...</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">¬øEs Cliente?</label>
                      <select class="form-select" name="is_client" required>
                        <option value="">Seleccionar...</option>
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                      </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">üíæ Guardar Contraparte</button>
                  </form>
                <div id="counterpartyAlert" class="mt-3" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = 'https://9bd89oc6j9.execute-api.us-east-1.amazonaws.com/dev';
    const clients = [];
    const transactions = [];
    const counterparties = [];
    
    let clientsData = null;
    let transactionsData = null;
    let counterpartiesData = null;
    let clientsTxStateData = null;
    let clientRecentActivityData = null;

    function parseCSV(text) {
      const lines = text.split('\n');
      const result = [];
      
      for (let line of lines) {
        if (!line.trim()) continue;
        
        const row = [];
        let current = '';
        let inQuotes = false;
        let quoteCount = 0;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            quoteCount++;
            if (i > 0 && line[i-1] === '"') {
              current += char;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            row.push(current.trim());
            current = '';
            quoteCount = 0;
          } else {
            current += char;
          }
        }
        row.push(current.trim());
        result.push(row);
      }
      
      return result;
    }

    function showAlert(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `alert alert-${type}`;
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    document.getElementById('clientForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const client = Object.fromEntries(formData);
      
      try {
        const response = await fetch(`${API_URL}/clients`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(client)
        });
        
        if (response.ok) {
          showAlert('clientAlert', '‚úÖ Cliente guardado exitosamente', 'success');
          e.target.reset();
        } else {
          showAlert('clientAlert', '‚ùå Error al guardar cliente', 'danger');
        }
      } catch (error) {
        showAlert('clientAlert', '‚ùå Error de conexi√≥n', 'danger');
      }
    });

    document.getElementById('transactionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const transaction = Object.fromEntries(formData);
      
      try {
        const response = await fetch(`${API_URL}/transactions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(transaction)
        });
        
        if (response.ok) {
          showAlert('transactionAlert', '‚úÖ Transacci√≥n guardada exitosamente', 'success');
          e.target.reset();
        } else {
          showAlert('transactionAlert', '‚ùå Error al guardar transacci√≥n', 'danger');
        }
      } catch (error) {
        showAlert('transactionAlert', '‚ùå Error de conexi√≥n', 'danger');
      }
    });

    document.getElementById('clientCsvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        clientsData = null;
        document.getElementById('uploadClientsBtn').disabled = true;
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const csv = event.target.result;
          const rows = parseCSV(csv);
          
          if (!rows || rows.length === 0) {
            showAlert('uploadAlert', '‚ùå Error: CSV vac√≠o o inv√°lido', 'danger');
            document.getElementById('clientCsvFile').value = '';
            return;
          }
          
          const headers = rows[0].map(h => h.trim());
          
          clientsData = [];
          for (let i = 1; i < rows.length; i++) {
            if (rows[i].length < 2) continue;
            
            const client = {};
            headers.forEach((header, index) => {
              client[header] = rows[i][index] || '';
            });
            clientsData.push(client);
          }
          
          document.getElementById('uploadClientsBtn').disabled = false;
          document.getElementById('uploadClientsBtn').textContent = `üì§ Cargar ${clientsData.length} Clientes`;
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showAlert('uploadAlert', '‚ùå Error al procesar CSV: ' + error.message, 'danger');
          document.getElementById('clientCsvFile').value = '';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('uploadClientsBtn').addEventListener('click', async function() {
      if (!clientsData) return;
      
      this.disabled = true;
      this.textContent = '‚è≥ Cargando...';
      
      let count = 0;
      for (const client of clientsData) {
        try {
          const response = await fetch(`${API_URL}/clients`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(client)
          });
          
          if (response.ok) {
            count++;
          }
        } catch (error) {
          console.error('Error uploading client:', error);
        }
      }
      
      showAlert('uploadAlert', `‚úÖ ${count} clientes cargados exitosamente`, 'success');
      document.getElementById('clientCsvFile').value = '';
      clientsData = null;
      this.disabled = true;
      this.textContent = 'üì§ Cargar Clientes';
    });

    document.getElementById('transactionCsvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        transactionsData = null;
        document.getElementById('uploadTransactionsBtn').disabled = true;
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const csv = event.target.result;
          const rows = parseCSV(csv);
          
          if (!rows || rows.length === 0) {
            showAlert('uploadAlert', '‚ùå Error: CSV vac√≠o o inv√°lido', 'danger');
            document.getElementById('transactionCsvFile').value = '';
            return;
          }
          
          const headers = rows[0].map(h => h.trim());
          
          transactionsData = [];
          for (let i = 1; i < rows.length; i++) {
            if (rows[i].length < 2) continue;
            
            const transaction = {};
            headers.forEach((header, index) => {
              transaction[header] = rows[i][index] || '';
            });
            transactionsData.push(transaction);
          }
          
          document.getElementById('uploadTransactionsBtn').disabled = false;
          document.getElementById('uploadTransactionsBtn').textContent = `üì§ Cargar ${transactionsData.length} Transacciones`;
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showAlert('uploadAlert', '‚ùå Error al procesar CSV: ' + error.message, 'danger');
          document.getElementById('transactionCsvFile').value = '';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('uploadTransactionsBtn').addEventListener('click', async function() {
      if (!transactionsData) return;
      
      this.disabled = true;
      this.textContent = '‚è≥ Cargando...';
      
      let count = 0;
      for (const transaction of transactionsData) {
        try {
          const response = await fetch(`${API_URL}/transactions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transaction)
          });
          
          if (response.ok) {
            count++;
          }
        } catch (error) {
          console.error('Error uploading transaction:', error);
        }
      }
      
      showAlert('uploadAlert', `‚úÖ ${count} transacciones cargadas exitosamente`, 'success');
      document.getElementById('transactionCsvFile').value = '';
      transactionsData = null;
      this.disabled = true;
      this.textContent = 'üì§ Cargar Transacciones';
    });

    document.getElementById('counterpartyCsvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        counterpartiesData = null;
        document.getElementById('uploadCounterpartiesBtn').disabled = true;
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const csv = event.target.result;
          const rows = parseCSV(csv);
          
          if (!rows || rows.length === 0) {
            showAlert('uploadAlert', '‚ùå Error: CSV vac√≠o o inv√°lido', 'danger');
            document.getElementById('counterpartyCsvFile').value = '';
            return;
          }
          
          const headers = rows[0].map(h => h.trim());
          
          counterpartiesData = [];
          for (let i = 1; i < rows.length; i++) {
            if (rows[i].length < 2) continue;
            
            const counterparty = {};
            headers.forEach((header, index) => {
              counterparty[header] = rows[i][index] || '';
            });
            counterpartiesData.push(counterparty);
          }
          
          document.getElementById('uploadCounterpartiesBtn').disabled = false;
          document.getElementById('uploadCounterpartiesBtn').textContent = `üì§ Cargar ${counterpartiesData.length} Contrapartes`;
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showAlert('uploadAlert', '‚ùå Error al procesar CSV: ' + error.message, 'danger');
          document.getElementById('counterpartyCsvFile').value = '';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('uploadCounterpartiesBtn').addEventListener('click', async function() {
      if (!counterpartiesData) return;
      
      this.disabled = true;
      this.textContent = '‚è≥ Cargando...';
      
      let count = 0;
      for (const counterparty of counterpartiesData) {
        try {
          const response = await fetch(`${API_URL}/counterparties`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(counterparty)
          });
          
          if (response.ok) {
            count++;
          }
        } catch (error) {
          console.error('Error uploading counterparty:', error);
        }
      }
      
      showAlert('uploadAlert', `‚úÖ ${count} contrapartes cargadas exitosamente`, 'success');
      document.getElementById('counterpartyCsvFile').value = '';
      counterpartiesData = null;
      this.disabled = true;
      this.textContent = 'üì§ Cargar Contrapartes';
    });

    document.getElementById('counterpartyForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const counterparty = Object.fromEntries(formData);
      
      try {
        const response = await fetch(`${API_URL}/counterparties`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(counterparty)
        });
        
        if (response.ok) {
          showAlert('counterpartyAlert', '‚úÖ Contraparte guardada exitosamente', 'success');
          e.target.reset();
        } else {
          showAlert('counterpartyAlert', '‚ùå Error al guardar contraparte', 'danger');
        }
      } catch (error) {
        showAlert('counterpartyAlert', '‚ùå Error de conexi√≥n', 'danger');
      }
    });

    document.getElementById('clientsTxStateCsvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        clientsTxStateData = null;
        document.getElementById('uploadClientsTxStateBtn').disabled = true;
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const csv = event.target.result;
          const rows = parseCSV(csv);
          
          if (!rows || rows.length === 0) {
            showAlert('uploadAlert', '‚ùå Error: CSV vac√≠o o inv√°lido', 'danger');
            document.getElementById('clientsTxStateCsvFile').value = '';
            return;
          }
          
          const headers = rows[0].map(h => h.trim());
          
          clientsTxStateData = [];
          for (let i = 1; i < rows.length; i++) {
            if (rows[i].length < 2) continue;
            
            const state = {};
            headers.forEach((header, index) => {
              state[header] = rows[i][index] || '';
            });
            clientsTxStateData.push(state);
          }
          
          document.getElementById('uploadClientsTxStateBtn').disabled = false;
          document.getElementById('uploadClientsTxStateBtn').textContent = `üì§ Cargar ${clientsTxStateData.length} Estados`;
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showAlert('uploadAlert', '‚ùå Error al procesar CSV: ' + error.message, 'danger');
          document.getElementById('clientsTxStateCsvFile').value = '';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('uploadClientsTxStateBtn').addEventListener('click', async function() {
      if (!clientsTxStateData) return;
      
      this.disabled = true;
      this.textContent = '‚è≥ Cargando...';
      
      let count = 0;
      for (const state of clientsTxStateData) {
        try {
          const response = await fetch(`${API_URL}/clients-tx-state`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(state)
          });
          
          if (response.ok) {
            count++;
          }
        } catch (error) {
          console.error('Error uploading client tx state:', error);
        }
      }
      
      showAlert('uploadAlert', `‚úÖ ${count} estados transaccionales cargados exitosamente`, 'success');
      document.getElementById('clientsTxStateCsvFile').value = '';
      clientsTxStateData = null;
      this.disabled = true;
      this.textContent = 'üì§ Cargar Estado Transaccional';
    });

    document.getElementById('clientRecentActivityCsvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        clientRecentActivityData = null;
        document.getElementById('uploadClientRecentActivityBtn').disabled = true;
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const csv = event.target.result;
          const rows = parseCSV(csv);
          
          if (!rows || rows.length === 0) {
            showAlert('uploadAlert', '‚ùå Error: CSV vac√≠o o inv√°lido', 'danger');
            document.getElementById('clientRecentActivityCsvFile').value = '';
            return;
          }
          
          const headers = rows[0].map(h => h.trim());
          
          clientRecentActivityData = [];
          for (let i = 1; i < rows.length; i++) {
            if (rows[i].length < 2) continue;
            
            const activity = {};
            headers.forEach((header, index) => {
              activity[header] = rows[i][index] || '';
            });
            clientRecentActivityData.push(activity);
          }
          
          document.getElementById('uploadClientRecentActivityBtn').disabled = false;
          document.getElementById('uploadClientRecentActivityBtn').textContent = `üì§ Cargar ${clientRecentActivityData.length} Actividades`;
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showAlert('uploadAlert', '‚ùå Error al procesar CSV: ' + error.message, 'danger');
          document.getElementById('clientRecentActivityCsvFile').value = '';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('uploadClientRecentActivityBtn').addEventListener('click', async function() {
      if (!clientRecentActivityData) return;
      
      this.disabled = true;
      this.textContent = '‚è≥ Cargando...';
      
      let count = 0;
      for (const activity of clientRecentActivityData) {
        try {
          const response = await fetch(`${API_URL}/client-recent-activity`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(activity)
          });
          
          if (response.ok) {
            count++;
          }
        } catch (error) {
          console.error('Error uploading client recent activity:', error);
        }
      }
      
      showAlert('uploadAlert', `‚úÖ ${count} actividades recientes cargadas exitosamente`, 'success');
      document.getElementById('clientRecentActivityCsvFile').value = '';
      clientRecentActivityData = null;
      this.disabled = true;
      this.textContent = 'üì§ Cargar Actividad Reciente';
    });
  </script>
</body>
</html>
